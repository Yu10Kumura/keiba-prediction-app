# 競馬走破タイム予測アプリケーション 要件定義書

**バージョン**: 1.0  
**作成日**: 2025年10月12日  
**対象システム**: Streamlit × LightGBM 競馬タイム予測Webアプリ

---

## 1. システム概要

### 1.1 目的
競馬の「走破タイム」を高精度で推定するWebアプリケーションを社内利用向けに提供し、レース分析業務の効率化を図る。

### 1.2 対象ユーザー
- 社内の競馬分析担当者
- レース予想・分析業務従事者
- 初期段階では認証不要（社内LAN環境想定）

### 1.3 技術スタック
- **フロントエンド**: Streamlit
- **機械学習**: LightGBM（学習済みモデル）
- **言語**: Python 3.9+
- **運用環境**: 社内LAN

---

## 2. 機能要件

### 2.1 入力モード

#### 2.1.1 モードA: ファイルアップロード
- **対象ファイル**: Excel（.xlsx）、CSV（.csv）
- **処理方式**: 一括予測
- **最大行数**: 10,000行（設定変更可能）
- **エンコーディング**: UTF-8、Shift_JIS自動判定

#### 2.1.2 モードB: 手入力フォーム
- **処理方式**: 1件ずつ入力・即時予測
- **履歴機能**: 予測結果を任意で履歴に追加
- **履歴管理**: セッション内保持、CSV出力可能

### 2.2 入力項目定義

#### 2.2.1 ユーザー入力項目（9列）
| 項目名 | データ型 | 必須 | 制約 | 備考 |
|--------|----------|------|------|------|
| 年月日 | 日付 | ○ | 1990/1/1～2030/12/31 | YYYY/MM/DD形式 |
| 場所 | 文字列 | ○ | 競馬場名 | 東京、阪神等 |
| 芝・ダ | 文字列 | ○ | 「芝」または「ダ」 | - |
| 距離 | 数値 | ○ | 800～4000（メートル） | 整数 |
| 馬場状態 | 文字列 | ○ | 良、稍重、重、不良 | - |
| 馬名 | 文字列 | ○ | 1～30文字 | 全角・半角混在可 |
| 馬番 | 数値 | ○ | 1～18 | 整数 |
| 父馬名 | 文字列 | ○ | 1～30文字 | 全角・半角混在可 |
| 母の父馬名 | 文字列 | ○ | 1～30文字 | 全角・半角混在可 |

#### 2.2.2 自動付与項目（4列）
| 項目名 | データ型 | 付与方法 | デフォルト値 |
|--------|----------|----------|--------------|
| 父馬名_小系統 | 文字列 | 血統マスタ参照 | UNK |
| 父馬名_国系統 | 文字列 | 血統マスタ参照 | UNK |
| 母の父馬名_小系統 | 文字列 | 血統マスタ参照 | UNK |
| 母の父馬名_国系統 | 文字列 | 血統マスタ参照 | UNK |

### 2.3 血統マスタ参照仕様

#### 2.3.1 マッピング処理
- **正規化処理**: NFKC正規化 + 前後空白除去
- **照合方式**: 完全一致
- **未登録馬処理**: 「UNK」を自動割り当て

#### 2.3.2 血統マスタ構造
```
馬名 → {
  小系統: "系統名",
  国系統: "系統名"
}
```

### 2.4 出力仕様

#### 2.4.1 予測結果項目
- **元入力項目**: 9列（ユーザー入力データそのまま）
- **自動付与項目**: 4列（血統系統データ）
- **予測結果**: predicted_time_sec（秒、小数第3位まで）

#### 2.4.2 出力形式
- **ファイルアップロード**: Excel/CSV形式でダウンロード
- **手入力**: 画面表示 + 履歴追加オプション
- **履歴出力**: CSV形式でダウンロード

---

## 3. UI/UX要件

### 3.1 画面構成

#### 3.1.1 メイン画面
- **ヘッダー**: アプリタイトル、モデルバージョン表示
- **モード選択**: タブ形式（ファイルアップロード / 手入力）
- **サイドバー**: 設定・ヘルプ・履歴管理

#### 3.1.2 ファイルアップロード画面
- **ファイル選択**: ドラッグ&ドロップ対応
- **プレビュー表示**: 先頭10行のデータ確認
- **バリデーション結果**: エラー・警告の一覧表示
- **処理実行**: 予測実行ボタン
- **結果表示**: 統計サマリー + ダウンロードボタン

#### 3.1.3 手入力画面
- **入力フォーム**: 9項目の入力欄
- **バリデーション**: リアルタイム入力チェック
- **予測実行**: 即時予測ボタン
- **結果表示**: 予測タイム + 詳細情報
- **履歴管理**: 追加ボタン + 履歴一覧

### 3.2 ユーザビリティ要件
- **日本語UI**: 全ての表示・メッセージを日本語で提供
- **レスポンシブ**: デスクトップ・タブレット対応
- **直感的操作**: 業務フローに沿った画面遷移
- **エラー表示**: 分かりやすいエラーメッセージ

---

## 4. エラーハンドリング・バリデーション

### 4.1 入力バリデーション

#### 4.1.1 必須チェック
- **対象**: 全ての必須項目（9列）
- **処理**: 未入力時はエラーメッセージ表示

#### 4.1.2 データ型チェック
- **日付**: 日付形式・範囲チェック
- **数値**: 数値型・範囲チェック
- **文字列**: 文字数制限チェック

#### 4.1.3 業務ルールチェック
- **競馬場名**: 登録済み競馬場名との照合
- **馬場状態**: 定義済み値との照合
- **芝・ダ**: 「芝」「ダ」以外はエラー

### 4.2 ファイル処理エラー

#### 4.2.1 ファイル形式エラー
- **対象**: 非対応ファイル、破損ファイル
- **処理**: エラーメッセージ表示、処理停止

#### 4.2.2 データ量制限
- **行数上限**: 10,000行
- **ファイルサイズ**: 50MB
- **処理**: 上限超過時は警告、選択的処理継続

#### 4.2.3 エンコーディングエラー
- **処理**: UTF-8、Shift_JIS自動判定・変換
- **失敗時**: エラーメッセージ、手動エンコーディング指定

### 4.3 予測処理エラー

#### 4.3.1 モデル読み込みエラー
- **原因**: ファイル破損、バージョン不整合
- **処理**: システムエラーとして表示、管理者連絡案内

#### 4.3.2 予測実行エラー
- **原因**: 特徴量不整合、メモリ不足
- **処理**: エラー詳細表示、部分的処理継続可能な場合は選択肢提示

---

## 5. 非機能要件

### 5.1 性能要件
- **応答時間**: 
  - 手入力予測: 3秒以内
  - ファイル処理: 1,000行あたり30秒以内
- **同時接続**: 10ユーザー
- **可用性**: 業務時間内99%稼働

### 5.2 拡張性要件
- **列追加**: 新特徴量の容易な追加
- **モデル差し替え**: バージョンアップ対応
- **マスタ更新**: 血統マスタの定期更新

### 5.3 運用要件
- **ログ出力**: アクセスログ、エラーログ（将来拡張）
- **バックアップ**: 設定・マスタファイルの定期バックアップ
- **監視**: 死活監視、リソース監視（将来拡張）

### 5.4 セキュリティ要件
- **アクセス制御**: 初期段階では社内LAN制限のみ
- **データ保護**: アップロードファイルの一時保存・自動削除
- **認証**: 将来拡張として検討

---

## 6. 制約事項

### 6.1 技術制約
- **実行環境**: Python 3.9+、Streamlit
- **データベース**: 初期段階では不使用（ファイルベース）
- **外部API**: 使用しない

### 6.2 業務制約
- **利用時間**: 業務時間内（9:00-18:00）を主対象
- **データ範囲**: 1990年以降の競馬データ
- **更新頻度**: 血統マスタは月1回更新

### 6.3 運用制約
- **サポート**: 平日業務時間内のみ
- **メンテナンス**: 週末夜間実施
- **データ保持**: 履歴データは1年間保持

---

## 7. 将来拡張計画

### 7.1 機能拡張
- **ユーザー認証**: LDAP連携
- **権限管理**: ロール別アクセス制御
- **API提供**: REST API による外部連携
- **レポート機能**: 予測精度分析、傾向レポート

### 7.2 技術拡張
- **データベース化**: PostgreSQL/MySQL導入
- **ログ・監査**: 詳細ログ、監査証跡
- **モデル管理**: MLOps対応、A/Bテスト

### 7.3 業務拡張
- **多モデル対応**: 距離別・条件別モデル
- **リアルタイム更新**: レース結果の即時反映
- **外部データ連携**: JRA公式データとの連携

---

## 8. 受け入れ基準

### 8.1 機能受け入れ基準
- [ ] ファイルアップロード機能が正常動作する
- [ ] 手入力機能が正常動作する
- [ ] 血統マスタ参照が正常動作する
- [ ] 予測結果が適切な形式で出力される
- [ ] エラーハンドリングが適切に動作する

### 8.2 性能受け入れ基準
- [ ] 手入力予測が3秒以内で完了する
- [ ] 1,000行のファイル処理が30秒以内で完了する
- [ ] 同時5ユーザーでの動作が確認される

### 8.3 品質受け入れ基準
- [ ] 予測精度がテストデータでRMSE 2.0秒以内
- [ ] UI/UXが要件通りに実装される
- [ ] エラーメッセージが日本語で分かりやすく表示される

---

## 9. リスク・課題

### 9.1 技術リスク
- **モデル精度**: 未知データでの精度劣化リスク
- **処理性能**: 大量データ処理時のメモリ不足
- **互換性**: Streamlitバージョンアップ時の非互換

### 9.2 業務リスク
- **データ品質**: 入力データの品質ばらつき
- **運用負荷**: マスタデータ管理の継続性
- **利用者教育**: システム利用方法の浸透

### 9.3 対策
- **定期検証**: モデル精度の定期的な検証・更新
- **段階的展開**: 小規模から段階的に利用拡大
- **マニュアル整備**: 操作マニュアル・FAQ整備

---

**以上**
