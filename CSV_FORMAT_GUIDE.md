# 📄 CSV アップロード フォーマットガイド

V3統合版競馬予測システムでサポートされているCSVファイルの形式を説明します。

## 🎯 基本要件

### ファイル仕様
- **ファイル形式**: CSV (`.csv`)
- **最大ファイルサイズ**: 50MB
- **最大行数**: 10,000行
- **エンコーディング**: UTF-8, UTF-8 BOM, Shift_JIS, CP932

### エンコーディングの自動判定
システムが自動的に以下の順序でエンコーディングを試行します：
1. UTF-8
2. UTF-8 BOM
3. Shift_JIS
4. CP932

## 📋 必須列（V2/V3共通）

以下の列は**必須**です：

| 列名 | データ型 | 説明 | 例 |
|------|----------|------|-----|
| `年月日` | 文字列 | レース日付 | `20250101` |
| `場所` | 文字列 | 競馬場名 | `東京`, `中山`, `阪神` |
| `芝・ダ` | 文字列 | コース種別 | `芝` または `ダ` |
| `距離` | 整数 | コース距離（メートル） | `1200`, `2000`, `2400` |
| `馬場状態` | 文字列 | 馬場状態 | `良`, `稍重`, `重`, `不良` |
| `馬番` | 整数 | 馬番 | `1`～`18` |

## 🔧 オプション列（血統情報）

血統情報がない場合は自動付与されます：

| 列名 | データ型 | 説明 | 例 |
|------|----------|------|-----|
| `馬名` | 文字列 | 馬名 | `ディープインパクト` |
| `父馬名` | 文字列 | 父馬名 | `サンデーサイレンス` |
| `母の父馬名` | 文字列 | 母の父馬名 | `Halo` |

## 🚀 V3専用列（高精度予測用）

V3の新機能（脚質推定、順位予測）には以下の列が有効です：

| 列名 | データ型 | 説明 | 例 |
|------|----------|------|-----|
| `頭数` | 整数 | 出走頭数 | `16` |
| `斤量` | 小数 | 騎手の負担重量 | `56.0`, `57.5` |
| `通過順1` | 整数 | 1コーナー通過順位 | `1`～`18` |
| `通過順2` | 整数 | 2コーナー通過順位 | `1`～`18` |
| `通過順3` | 整数 | 3コーナー通過順位 | `1`～`18` |
| `通過順4` | 整数 | 4コーナー通過順位 | `1`～`18` |
| `上がり3Fタイム` | 小数 | 上がり3ハロンタイム | `33.5`, `34.2` |
| `騎手名` | 文字列 | 騎手名 | `武豊`, `川田将雅` |
| `調教師` | 文字列 | 調教師名 | `藤沢和雄` |
| `走破タイム` | 小数 | 実際の走破タイム（秒） | `120.5` |

## 🎯 CSVテンプレート

### 基本テンプレート（V2/V3共通）
```csv
年月日,場所,芝・ダ,距離,馬場状態,馬名,馬番,父馬名,母の父馬名
20250101,東京,芝,2000,良,サンプル馬1,1,ディープインパクト,サンデーサイレンス
20250101,東京,芝,2000,良,サンプル馬2,2,オルフェーヴル,キングカメハメハ
```

### V3詳細テンプレート（全機能対応）
```csv
年月日,場所,芝・ダ,距離,馬場状態,馬名,馬番,父馬名,母の父馬名,頭数,斤量,通過順1,通過順2,通過順3,通過順4,上がり3Fタイム,騎手名,調教師,走破タイム
20250101,東京,芝,2000,良,サンプル馬1,1,ディープインパクト,サンデーサイレンス,16,56,1,1,2,1,33.5,騎手A,調教師A,120.5
20250101,東京,芝,2000,良,サンプル馬2,2,オルフェーヴル,キングカメハメハ,16,57,3,3,3,2,34.2,騎手B,調教師B,120.7
```

## 📊 有効な値の範囲

### 競馬場（場所）
```
札幌, 函館, 福島, 新潟, 東京, 中山, 中京, 京都, 阪神, 小倉, 
大井, 川崎, 船橋, 浦和, 水沢, 盛岡, 門別, 帯広, 旭川, 
佐賀, 荒尾, 高知, 園田, 姫路, 益田, 笠松, 名古屋, 金沢
```

### コース種別（芝・ダ）
```
芝, ダ
```

### 馬場状態
```
良, 稍重, 重, 不良
```

### 距離
- **最小**: 800m
- **最大**: 4000m

### 馬番
- **最小**: 1
- **最大**: 18

### 年月日フォーマット
```
YYYYMMDD形式（例: 20250101）
```

## ⚠️ よくあるエラーと対処法

### 1. エンコーディングエラー
**エラー**: `UnicodeDecodeError`
**対処法**: ファイルをUTF-8で保存し直すか、Excel で「CSV UTF-8」形式で保存

### 2. 必須列不足
**エラー**: `必須列が見つかりません`
**対処法**: 必須6列（年月日, 場所, 芝・ダ, 距離, 馬場状態, 馬番）を確認

### 3. データ型不一致
**エラー**: `データ型が不正です`
**対処法**: 数値列に文字列が混入していないか確認

### 4. 値の範囲外
**エラー**: `値が範囲外です`
**対処法**: 距離、馬番、年月日の値が有効範囲内か確認

## 🔄 V2とV3の違い

### V2モード
- 基本的な走破タイム予測
- 必須6列があれば動作
- 血統情報の自動付与

### V3モード
- **順位予測機能**: 同一レース内での順位予測
- **脚質推定**: 通過順データから脚質を推定
- **レース展開分析**: より詳細なレース分析
- V3専用列があると精度向上

## 📁 サンプルファイルのダウンロード

アプリケーション内の「データ」フォルダに以下のテンプレートファイルが用意されています：

- `csv_template_basic.csv`: 基本テンプレート
- `csv_template_v3.csv`: V3詳細テンプレート

## 💡 ベストプラクティス

1. **V3を使用する場合**: 通過順データ（通過順1〜4）を含めることで精度が大幅向上
2. **レース単位での入力**: 同じレースの複数の馬を一緒にアップロードすると順位予測が可能
3. **血統情報**: 父馬名・母の父馬名があると予測精度が向上
4. **エンコーディング**: Excel使用時は「CSV UTF-8」で保存を推奨

---

🏇 **競馬予測システム V3統合版** - より正確で実用的な競馬予測のために