# 競馬走破タイム予測アプリ

## 概要
LightGBMを用いた競馬の走破タイム予測Webアプリケーションです。  
Streamlitベースで、ファイルアップロード一括処理と手入力による即時予測の両方に対応しています。

## 機能
- **ファイルアップロード予測**: Excel/CSVファイルの一括処理
- **手入力予測**: フォーム入力による即時予測
- **血統マスタ自動参照**: 父馬・母父馬の系統情報自動付与
- **履歴管理**: 手入力予測結果の履歴保存・CSV出力

## 技術スタック
- **フロントエンド**: Streamlit
- **機械学習**: LightGBM
- **言語**: Python 3.9+
- **データ形式**: CSV, Excel

## セットアップ

### 1. 環境構築
```bash
cd ver1.Streamlit.Sim.APP/
python -m venv venv
source venv/bin/activate  # macOS/Linux
# または
venv\Scripts\activate  # Windows

pip install -r requirements.txt
```

### 2. モデルファイル配置
既存のml_modelsから学習済みモデルをコピー:
```bash
cp ../ml_models/models/lgb_model_final.pkl models/
cp ../ml_models/models/label_encoders.pkl models/
cp ../ml_models/models/feature_list.pkl models/
```

### 3. データファイル配置
血統マスタ等の参照データを配置:
```bash
cp ../ml_models/data/bloodline_master.csv data/
```

### 4. アプリケーション起動
```bash
streamlit run src/app.py
```

## 使用方法

### ファイルアップロード
1. 「ファイルアップロード」タブを選択
2. Excel/CSVファイルをドラッグ&ドロップ
3. データプレビューを確認
4. 「予測実行」ボタンをクリック
5. 結果をダウンロード

### 手入力
1. 「手入力」タブを選択
2. 必要項目を入力（年月日、場所、距離等）
3. 「予測実行」ボタンをクリック
4. 結果を確認・履歴追加（オプション）

## 入力項目
| 項目 | 必須 | 形式 | 例 |
|------|------|------|-----|
| 年月日 | ○ | YYYY/MM/DD | 2025/06/29 |
| 場所 | ○ | 競馬場名 | 東京、阪神 |
| 芝・ダ | ○ | 芝/ダ | 芝 |
| 距離 | ○ | 数値(m) | 1600 |
| 馬場状態 | ○ | 良/稍重/重/不良 | 良 |
| 馬名 | ○ | 文字列 | ディープインパクト |
| 馬番 | ○ | 1-18 | 3 |
| 父馬名 | ○ | 文字列 | サンデーサイレンス |
| 母の父馬名 | ○ | 文字列 | ノーザンテースト |

血統系統情報（父馬名_小系統、父馬名_国系統、母の父馬名_小系統、母の父馬名_国系統）は自動付与されます。

## 出力
- **予測タイム**: 秒単位（小数第3位まで）
- **入力データ**: 元の入力項目
- **血統情報**: 自動付与された系統情報

## ファイル構成
```
ver1.Streamlit.Sim.APP/
├── src/           # ソースコード
├── models/        # 学習済みモデル
├── data/          # マスタデータ
├── config/        # 設定ファイル
├── docs/          # ドキュメント
├── logs/          # ログファイル
└── tests/         # テストコード
```

## 開発者向け情報

### テスト実行
```bash
python -m pytest tests/
```

### ログ確認
```bash
tail -f logs/app.log
```

### 設定変更
`config/app_config.yaml` で各種設定を変更可能

## トラブルシューティング

### よくある問題
1. **モデルファイルが見つからない**: models/フォルダにpklファイルが配置されているか確認
2. **血統情報が「UNK」になる**: data/bloodline_master.csvに該当馬名が登録されているか確認
3. **ファイルアップロードエラー**: ファイル形式・エンコーディングを確認

### サポート
社内システム管理者にお問い合わせください。

## ライセンス
社内利用限定

## バージョン履歴
- v1.0: 初期版リリース（2025年10月）

---
**開発**: 競馬分析チーム  
**最終更新**: 2025年10月12日
