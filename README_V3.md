# 競馬走破タイム予測システム V3 Phase 1統合版

🏆 **V3 Phase 1で順位相関0.967を達成！（従来比8.1倍向上）**

## 🔥 V3 Phase 1の新機能

### 主要改善点
- **🎯 Phase 1改善版脚質推定**: 通過順データを活用した高精度な脚質分類
- **🏆 レース内順位予測**: 同一レース内での順位予測機能
- **📊 レース展開分析**: 脚質分布とペース予想による展開分析
- **⚡ 騎手・調教師統計**: 過去成績データの活用
- **📈 8.1倍の精度向上**: V1比で順位相関が大幅向上

### パフォーマンス指標
| モデル | 順位相関 | 改善率 | 特徴量数 | 新機能 |
|--------|----------|---------|----------|--------|
| V1 | 0.120 | - | 16 | - |
| V2 | 0.927 | 7.7倍 | 16 | - |
| **V3 Phase 1** | **0.967** | **8.1倍** | **28** | ✅ |

## 🚀 起動方法

### 標準起動
```bash
streamlit run app.py
```

### V3専用起動スクリプト
```bash
python run_v3_app.py
```

## 📋 機能概要

### 🎯 予測システム（メインタブ）
- **ファイル入力**: CSVファイルからの一括予測
- **手動入力**: 個別レースデータの入力
- **血統情報自動付与**: 父馬・母父馬の血統分類
- **タイム予測**: LightGBMによる走破タイム予測

### 🎮 V3 デモ（デモタブ）
- **サンプルレース順位予測**: 5頭立てレースの順位予測デモ
- **単頭予測テスト**: 個別馬の予測テスト
- **脚質推定デモ**: Phase 1改善版の脚質推定
- **V2との比較**: 性能向上の可視化

### 📊 設定・情報（情報タブ）
- **モデル情報**: 現在のモデル状態と性能指標
- **システム機能**: V2/V3の機能比較
- **詳細比較表**: 全バージョンの詳細比較

## 🔄 V2/V3切り替え

サイドバーの「🤖 モデル選択」から簡単に切り替え可能:
- **V3**: 最新版（順位予測、脚質推定対応）
- **V2**: 従来版（安定版）

## 🏃 V3の脚質推定

### 改善されたアルゴリズム
1. **通過順データ活用**: 4コーナーまでの位置取り分析
2. **頭数正規化**: レース規模に応じた相対位置計算
3. **展開パターン認識**: 位置変化による脚質判定
4. **高精度分類**: 逃げ/先行/差し/追込の4分類

### 脚質タイプ
- 🚀 **逃げ**: 先頭逃げ切り型
- ⚡ **先行**: 前々団好位型  
- 💨 **差し**: 中団抜け出し型
- ⚔️ **追込**: 後方末脚型

## 🏆 順位予測機能

### 機能概要
- **レース内順位**: 同一レース参加馬の順位予測
- **タイム分析**: 予想走破タイムの分布
- **展開予想**: 脚質分布によるレース展開分析
- **視覚化**: プロット図による直感的な表示

### 予測結果表示
- **🥇🥈🥉 メダル表示**: 上位3着の強調表示
- **脚質分布グラフ**: 円グラフによる脚質割合
- **タイム分布**: 馬別予想タイムのバーチャート
- **展開シナリオ**: ペース予想とコメント

## 📁 ファイル構造

```
ver1_streamlit_sim_app/
├── app.py                          # メインアプリケーション
├── run_v3_app.py                   # V3専用起動スクリプト
├── config/
│   └── app_config.yaml             # V3対応設定ファイル
└── src/
    ├── components/
    │   ├── data_input.py           # ファイル入力コンポーネント
    │   ├── manual_input.py         # 手動入力コンポーネント  
    │   ├── result_display.py       # V2結果表示
    │   └── result_display_v3.py    # V3結果表示（新規）
    ├── core/
    │   ├── prediction_engine.py    # V2予測エンジン
    │   └── prediction_engine_v3.py # V3予測エンジン（新規）
    ├── constants/
    │   └── columns.py              # V3特徴量対応
    └── utils/
        ├── config_manager.py       # 設定管理
        └── v3_demo_utils.py        # V3デモ機能（新規）
```

## 🛠️ 必要な環境

### Python パッケージ
- `streamlit >= 1.25.0`
- `pandas >= 1.5.0`
- `numpy >= 1.21.0`
- `lightgbm >= 3.3.0`
- `plotly >= 5.10.0`
- `scipy >= 1.9.0`

### モデルファイル
- V3モデル: `../ml_models_v3/models/keiba_model_v3_*.pkl`
- V2モデル: `models/keiba_timeseries_lgb_*.pkl`

## 🎯 使用例

### レース順位予測の例
```python
# V3エンジンでのレース予測
race_data = pd.DataFrame({
    '馬名': ['ウマA', 'ウマB', 'ウマC'],
    '馬番': [1, 2, 3],
    '距離': [2000, 2000, 2000],
    # ... その他の特徴量
})

result = v3_engine.predict_race_order(race_data)
# → 順位予測、脚質、タイム分析を含む結果
```

## 📈 パフォーマンス

### V3 Phase 1の成果
- **順位相関**: 0.967（目標0.95を上回る）
- **RMSE**: 1.068秒（高精度維持）
- **特徴量**: 28個（脚質、騎手統計等追加）
- **新機能**: 順位予測、脚質推定、レース展開分析

### 実用性向上
- レース展開の予想が可能
- 馬券購入戦略への活用
- より実践的な競馬分析

## 🔄 今後の開発予定

### Phase 2計画
- [ ] より高度な騎手・調教師分析
- [ ] 馬場状態の詳細分析
- [ ] レース距離別の特化モデル
- [ ] リアルタイム予測機能

### Phase 3以降
- [ ] 深層学習モデルの統合
- [ ] 多目的最適化の適用
- [ ] より豊富な外部データ活用

## 📞 サポート

問題や質問がありましたら、開発チームまでお問い合わせください。

---

🏇 **競馬Sim V3 Phase 1** - より正確で実用的な競馬予測を目指して